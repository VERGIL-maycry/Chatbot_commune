<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Assistant virtuel de la Commune de FÃ¨s - Services administratifs et informations municipales">
    <meta name="robots" content="index, follow">
    <title>Chatbot - Commune de FÃ¨s</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGRlZnM+CjxsaW5lYXJHcmFkaWVudCBpZD0iZ3JhZCIgeDE9IjAlIiB5MT0iMCUiIHgyPSIxMDAlIiB5Mj0iMTAwJSI+CjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiMyRTg2QzEiLz4KPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjNURBREUyIi8+CjwvbGluZWFyR3JhZGllbnQ+CjwvZGVmcz4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNiIgZmlsbD0idXJsKCNncmFkKSIvPgo8dGV4dCB4PSI3IiB5PSIyMiIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE2IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0id2hpdGUiPtmBPC90ZXh0Pgo8L3N2Zz4K">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <!-- ===== MAIN CHAT CONTAINER ===== -->
    <div class="chat-container">
        <!-- ===== CHAT HEADER ===== -->
        <div class="chat-header">
            <div class="header-logo">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/56/Commune_de_F%C3%A9s.png" 
                     alt="Logo Commune de FÃ¨s" 
                     class="logo-image" />
                <div class="header-text">
                    <h1>Ù…Ø³Ø§Ø¹Ø¯ Ø§Ù„Ø¬Ù…Ø§Ø¹Ø© Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ</h1>
                    <span>Assistant virtuel - Commune de FÃ¨s</span>
                </div>
            </div>
            <div class="header-controls">
                <form method="POST" action="{{ url_for('clear_chat') }}" style="margin: 0;">
                    <input type="hidden" name="session_id" value="{{ session_id }}">
                    <button type="submit" class="control-btn" title="Effacer l'historique" aria-label="Effacer l'historique">
                        ğŸ—‘ï¸
                    </button>
                </form>
                
                <form method="POST" action="{{ url_for('toggle_font_size') }}" style="margin: 0;">
                    <input type="hidden" name="session_id" value="{{ session_id }}">
                    <button type="submit" class="control-btn" title="{{ font_size_tooltip }}" aria-label="Changer la taille de police">
                        {{ font_size_icon }}
                    </button>
                </form>
                
                <form method="POST" action="{{ url_for('toggle_theme') }}" style="margin: 0;">
                    <input type="hidden" name="session_id" value="{{ session_id }}">
                    <button type="submit" class="control-btn" title="Changer le thÃ¨me" aria-label="Changer le thÃ¨me">
                        {{ theme_icon }}
                    </button>
                </form>
            </div>
        </div>
        
        <!-- ===== CHAT MESSAGES AREA ===== -->
        <div class="chat-messages" id="chatMessages">
            {% for message in chat_history %}
                <div class="message {{ message.sender }}">
                    {{ message.text | safe }}
                </div>
            {% endfor %}
        </div>
        
        <!-- ===== QUICK REPLY BUTTONS ===== -->
        {% if not in_conversation %}
        <div class="quick-replies">
            <form style="display: inline;">
                <button type="button" data-question="Horaires d'ouverture" class="quick-reply-btn">â° Horaires</button>
                <button type="button" data-question="Adresse de la mairie" class="quick-reply-btn">ğŸ“ Adresse</button>
                <button type="button" data-question="Certificat de rÃ©sidence" class="quick-reply-btn">ğŸ  Certificat rÃ©sidence</button>
                <button type="button" data-question="Acte de naissance" class="quick-reply-btn">ğŸ“‹ Acte naissance</button>
                <button type="button" data-question="Carte d'identitÃ© nationale" class="quick-reply-btn">ğŸ†” CNI</button>
                <button type="button" data-question="Passeport" class="quick-reply-btn">ğŸ“˜ Passeport</button>
            </form>
        </div>
        {% else %}
        <div class="conversation-replies">
            <form style="display: inline;">
                {% for button in conversation_buttons %}
                    <button type="button" data-question="{{ button.value }}" class="quick-reply-btn">{{ button.text }}</button>
                {% endfor %}
            </form>
        </div>
        {% endif %}
        
        <!-- ===== CHAT INPUT FORM ===== -->
        <form class="chat-input" id="chatForm">
            <input type="hidden" name="session_id" value="{{ session_id }}">
            <div class="input-container">
                <input type="text" name="question" id="chatInput" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¤Ø§Ù„Ùƒ Ù‡Ù†Ø§... Ã‰crivez votre question..." autocomplete="off" required />
                <div class="suggestions-dropup" id="suggestionsDropup">
                    <div class="suggestions-list" id="suggestionsList">
                        <!-- Suggestions will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            <button type="submit" class="send-btn" id="sendButton">ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„</button>
        </form>
    </div>

    <script>
        // Suggestions data
        const suggestions = [
            { text: "Horaires d'ouverture", icon: "â°", category: "Informations gÃ©nÃ©rales" },
            { text: "Adresse de la mairie", icon: "ğŸ“", category: "Informations gÃ©nÃ©rales" },
            { text: "Certificat de rÃ©sidence", icon: "ğŸ ", category: "Documents" },
            { text: "Acte de naissance", icon: "ğŸ“‹", category: "Documents" },
            { text: "Carte d'identitÃ© nationale", icon: "ğŸ†”", category: "Documents" },
            { text: "Passeport", icon: "ğŸ“˜", category: "Documents" },
            { text: "Certificat de mariage", icon: "ğŸ’’", category: "Documents" },
            { text: "Taxes municipales", icon: "ğŸ’°", category: "Services" },
            { text: "Prise de rendez-vous", icon: "ğŸ“…", category: "Services" },
            { text: "Services en ligne", icon: "ğŸ’»", category: "Services" },
            { text: "PropretÃ© (signaler un problÃ¨me)", icon: "ğŸ§¹", category: "Services" },
            { text: "NumÃ©ro d'urgence", icon: "ğŸš¨", category: "Informations gÃ©nÃ©rales" },
            { text: "Certificat de dÃ©cÃ¨s", icon: "âš±ï¸", category: "Documents" },
            { text: "Permis de conduire", icon: "ğŸš—", category: "Documents" },
            { text: "DÃ©claration de travaux", icon: "ğŸ”¨", category: "Services" },
            { text: "Certificat d'urbanisme", icon: "ğŸ—ï¸", category: "Services" },
            { text: "Autorisation de stationnement", icon: "ğŸ…¿ï¸", category: "Services" },
            { text: "Certificat de conformitÃ©", icon: "âœ…", category: "Services" },
            { text: "Attestation de domiciliation", icon: "ğŸ¡", category: "Documents" },
            { text: "Copie d'acte", icon: "ğŸ“‘", category: "Documents" },
            { text: "LÃ©galisation de signature", icon: "âœï¸", category: "Services" },
            { text: "Certificat de nationalitÃ©", icon: "ğŸ‡²ğŸ‡¦", category: "Documents" },
            { text: "Attestation de rÃ©sidence", icon: "ğŸ ", category: "Documents" },
            { text: "Certificat de cÃ©libat", icon: "ğŸ‘¤", category: "Documents" }
        ];


        // Suggestions functionality
        function initializeSuggestions() {
            const chatInput = document.getElementById('chatInput');
            const suggestionsDropup = document.getElementById('suggestionsDropup');
            const suggestionsList = document.getElementById('suggestionsList');
            let selectedIndex = -1;
            let filteredSuggestions = [];

            // Show suggestions when user starts typing
            chatInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                
                if (query.length < 2) {
                    hideSuggestions();
                    return;
                }

                // Filter suggestions based on input
                filteredSuggestions = suggestions.filter(suggestion => 
                    suggestion.text.toLowerCase().includes(query) ||
                    suggestion.category.toLowerCase().includes(query)
                );

                if (filteredSuggestions.length > 0) {
                    showSuggestions(filteredSuggestions);
                } else {
                    hideSuggestions();
                }
            });

            // Handle keyboard navigation
            chatInput.addEventListener('keydown', function(e) {
                if (!suggestionsDropup.classList.contains('show')) return;

                switch(e.key) {
                    case 'ArrowUp':
                        e.preventDefault();
                        navigateSuggestions(-1);
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        navigateSuggestions(1);
                        break;
                    case 'Enter':
                        if (selectedIndex >= 0 && filteredSuggestions[selectedIndex]) {
                            e.preventDefault();
                            selectSuggestion(filteredSuggestions[selectedIndex]);
                        }
                        break;
                    case 'Escape':
                        hideSuggestions();
                        break;
                }
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!chatInput.contains(e.target) && !suggestionsDropup.contains(e.target)) {
                    hideSuggestions();
                }
            });

            function showSuggestions(suggestionsToShow) {
                suggestionsList.innerHTML = '';
                selectedIndex = -1;

                suggestionsToShow.forEach((suggestion, index) => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.innerHTML = `
                        <span class="suggestion-icon">${suggestion.icon}</span>
                        <span class="suggestion-text">${suggestion.text}</span>
                        <span class="suggestion-category">${suggestion.category}</span>
                    `;
                    
                    item.addEventListener('click', () => selectSuggestion(suggestion));
                    item.addEventListener('mouseenter', () => {
                        selectedIndex = index;
                        updateSelection();
                    });
                    
                    suggestionsList.appendChild(item);
                });

                suggestionsDropup.classList.add('show');
            }

            function hideSuggestions() {
                suggestionsDropup.classList.remove('show');
                selectedIndex = -1;
            }

            function navigateSuggestions(direction) {
                if (filteredSuggestions.length === 0) return;

                selectedIndex += direction;
                
                if (selectedIndex >= filteredSuggestions.length) {
                    selectedIndex = 0;
                } else if (selectedIndex < 0) {
                    selectedIndex = filteredSuggestions.length - 1;
                }

                updateSelection();
            }

            function updateSelection() {
                const items = suggestionsList.querySelectorAll('.suggestion-item');
                items.forEach((item, index) => {
                    item.classList.toggle('selected', index === selectedIndex);
                });

                // Scroll to selected item if needed
                if (selectedIndex >= 0) {
                    const selectedItem = items[selectedIndex];
                    if (selectedItem) {
                        selectedItem.scrollIntoView({ block: 'nearest' });
                    }
                }
            }

            function selectSuggestion(suggestion) {
                chatInput.value = suggestion.text;
                hideSuggestions();
                chatInput.focus();
            }
        }

        // AJAX Chat functionality
        function initializeAjaxChat() {
            const chatForm = document.getElementById('chatForm');
            const chatInput = document.getElementById('chatInput');
            const sendButton = document.getElementById('sendButton');
            const chatMessages = document.getElementById('chatMessages');
            const quickReplies = document.querySelector('.quick-replies');
            const conversationReplies = document.querySelector('.conversation-replies');

            // Handle form submission
            chatForm.addEventListener('submit', function(e) {
                e.preventDefault();
                const question = chatInput.value.trim();
                
                if (!question) return;

                sendMessage(question);
            });

            // Handle quick reply button clicks (for both initial and dynamically created buttons)
            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('quick-reply-btn')) {
                    e.preventDefault();
                    e.stopPropagation();
                    
                    let question = e.target.getAttribute('data-question');
                    
                    // If no data-question attribute, extract from text content
                    if (!question) {
                        question = e.target.textContent.replace(/^[^\s]*\s/, '').trim(); // Remove emoji and get text
                    }
                    
                    console.log('Quick reply clicked:', question); // Debug log
                    
                    if (!question) {
                        console.error('No question found for button:', e.target);
                        return;
                    }
                    
                    // Trigger the same flow as manual form submission
                    sendMessage(question);
                }
            });

            function sendMessage(question) {
                console.log('Sending message:', question); // Debug log
                
                // Validate question
                if (!question || question.trim() === '') {
                    console.error('Empty question provided to sendMessage');
                    return;
                }
                
                // Disable form while processing
                sendButton.disabled = true;
                sendButton.textContent = 'â³ Ø¥Ø±Ø³Ø§Ù„...';
                chatInput.disabled = true;

                // Add user message to chat immediately
                addMessageToChat('user', question);
                chatInput.value = '';

                // Hide suggestions
                const suggestionsDropup = document.getElementById('suggestionsDropup');
                if (suggestionsDropup) {
                    suggestionsDropup.classList.remove('show');
                }

                // Send AJAX request
                fetch('/chat_ajax', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: JSON.stringify({
                        question: question
                    })
                })
                .then(response => {
                    console.log('Response status:', response.status); // Debug log
                    return response.json();
                })
                .then(data => {
                    console.log('Response data:', data); // Debug log
                    if (data.success) {
                        // Add bot response to chat
                        addMessageToChat('bot', data.bot_response);
                        
                        // Update quick replies based on conversation state
                        updateQuickReplies(data.in_conversation, data.conversation_buttons);
                    } else {
                        // Handle error
                        addMessageToChat('bot', '<div class="answer-section"><p>Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p><p>DÃ©solÃ©, une erreur est survenue. Veuillez rÃ©essayer.</p></div>');
                    }
                })
                .catch(error => {
                    console.error('AJAX Error:', error);
                    addMessageToChat('bot', '<div class="answer-section"><p>Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p><p>DÃ©solÃ©, erreur de connexion. Veuillez rÃ©essayer.</p></div>');
                })
                .finally(() => {
                    // Re-enable form
                    sendButton.disabled = false;
                    sendButton.textContent = 'ğŸ“¤ Ø¥Ø±Ø³Ø§Ù„';
                    chatInput.disabled = false;
                    chatInput.focus();
                });
            }

            function addMessageToChat(sender, text) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                messageDiv.innerHTML = text;
                
                // Add animation
                messageDiv.style.opacity = '0';
                messageDiv.style.transform = 'translateY(20px)';
                
                chatMessages.appendChild(messageDiv);
                
                // Trigger animation
                setTimeout(() => {
                    messageDiv.style.opacity = '1';
                    messageDiv.style.transform = 'translateY(0)';
                    messageDiv.style.transition = 'all 0.4s ease-out';
                }, 10);
                
                // Scroll to bottom
                setTimeout(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 100);
            }

            function updateQuickReplies(inConversation, conversationButtons) {
                // Remove existing quick replies
                const existingQuickReplies = document.querySelector('.quick-replies');
                const existingConversationReplies = document.querySelector('.conversation-replies');
                
                if (existingQuickReplies) {
                    existingQuickReplies.remove();
                }
                if (existingConversationReplies) {
                    existingConversationReplies.remove();
                }

                if (inConversation && conversationButtons && conversationButtons.length > 0) {
                    // Create conversation replies
                    const conversationRepliesDiv = document.createElement('div');
                    conversationRepliesDiv.className = 'conversation-replies';
                    
                    const form = document.createElement('form');
                    form.style.display = 'inline';
                    
                    conversationButtons.forEach(button => {
                        const buttonElement = document.createElement('button');
                        buttonElement.type = 'button';
                        buttonElement.className = 'quick-reply-btn';
                        buttonElement.setAttribute('data-question', button.value);
                        buttonElement.textContent = button.text;
                        
                        // Add click handler for dynamically created buttons
                        buttonElement.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            const question = this.getAttribute('data-question') || this.textContent.trim();
                            if (question) {
                                sendMessage(question);
                            }
                        });
                        
                        form.appendChild(buttonElement);
                    });
                    
                    conversationRepliesDiv.appendChild(form);
                    chatForm.parentNode.insertBefore(conversationRepliesDiv, chatForm);
                } else if (!inConversation) {
                    // Create default quick replies
                    const quickRepliesDiv = document.createElement('div');
                    quickRepliesDiv.className = 'quick-replies';
                    
                    const form = document.createElement('form');
                    form.style.display = 'inline';
                    
                    const defaultButtons = [
                        { text: 'â° Horaires', value: 'Horaires d\'ouverture' },
                        { text: 'ğŸ“ Adresse', value: 'Adresse de la mairie' },
                        { text: 'ğŸ  Certificat rÃ©sidence', value: 'Certificat de rÃ©sidence' },
                        { text: 'ğŸ“‹ Acte naissance', value: 'Acte de naissance' },
                        { text: 'ğŸ†” CNI', value: 'Carte d\'identitÃ© nationale' },
                        { text: 'ğŸ“˜ Passeport', value: 'Passeport' }
                    ];
                    
                    defaultButtons.forEach(button => {
                        const buttonElement = document.createElement('button');
                        buttonElement.type = 'button';
                        buttonElement.className = 'quick-reply-btn';
                        buttonElement.setAttribute('data-question', button.value);
                        buttonElement.textContent = button.text;
                        
                        // Add click handler for dynamically created buttons
                        buttonElement.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            const question = this.getAttribute('data-question') || this.textContent.replace(/^[^\s]*\s/, '').trim();
                            if (question) {
                                sendMessage(question);
                            }
                        });
                        
                        form.appendChild(buttonElement);
                    });
                    
                    quickRepliesDiv.appendChild(form);
                    chatForm.parentNode.insertBefore(quickRepliesDiv, chatForm);
                }
            }
        }

        // Initialize AJAX chat after DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Apply theme class if needed
            const theme = '{{ theme }}' || 'dark';
            if (theme === 'light') {
                document.body.classList.add('light-theme');
            }
            
            // Apply font size
            const fontSize = '{{ font_size }}' || 'normal';
            if (fontSize !== 'normal') {
                document.body.setAttribute('data-font-size', fontSize);
            }
            
            // Auto-scroll to bottom of chat messages
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                setTimeout(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 100);
            }

            // Initialize suggestions functionality
            initializeSuggestions();
            
            // Initialize AJAX chat functionality
            initializeAjaxChat();
        });
    </script>
</body>
</html> 