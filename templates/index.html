<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="description" content="Assistant virtuel de la Commune de F√®s - Services administratifs et informations municipales">
    <meta name="robots" content="index, follow">
    <title>Chatbot - Commune de F√®s</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="icon" type="image/x-icon" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGRlZnM+CjxsaW5lYXJHcmFkaWVudCBpZD0iZ3JhZCIgeDE9IjAlIiB5MT0iMCUiIHgyPSIxMDAlIiB5Mj0iMTAwJSI+CjxzdG9wIG9mZnNldD0iMCUiIHN0b3AtY29sb3I9IiMyRTg2QzEiLz4KPHN0b3Agb2Zmc2V0PSIxMDAlIiBzdG9wLWNvbG9yPSIjNURBREUyIi8+CjwvbGluZWFyR3JhZGllbnQ+CjwvZGVmcz4KPHJlY3Qgd2lkdGg9IjMyIiBoZWlnaHQ9IjMyIiByeD0iNiIgZmlsbD0idXJsKCNncmFkKSIvPgo8dGV4dCB4PSI3IiB5PSIyMiIgZm9udC1mYW1pbHk9IkFyaWFsLCBzYW5zLXNlcmlmIiBmb250LXNpemU9IjE2IiBmb250LXdlaWdodD0iYm9sZCIgZmlsbD0id2hpdGUiPtmBPC90ZXh0Pgo8L3N2Zz4K">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Noto+Sans+Arabic:wght@300;400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <!-- ===== MAIN CHAT CONTAINER ===== -->
    <div class="chat-container">
        <!-- ===== CHAT HEADER ===== -->
        <div class="chat-header">
            <div class="header-logo">
                <img src="https://upload.wikimedia.org/wikipedia/commons/5/56/Commune_de_F%C3%A9s.png" 
                     alt="Logo Commune de F√®s" 
                     class="logo-image" />
                <div class="header-text">
                    <h1>ŸÖÿ≥ÿßÿπÿØ ÿßŸÑÿ¨ŸÖÿßÿπÿ© ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿä</h1>
                    <span>Assistant virtuel - Commune de F√®s</span>
                </div>
            </div>
            <div class="header-controls">
                <form method="POST" action="{{ url_for('clear_chat') }}" style="margin: 0;">
                    <input type="hidden" name="session_id" value="{{ session_id }}">
                    <button type="submit" class="control-btn" title="Effacer l'historique" aria-label="Effacer l'historique">
                        üóëÔ∏è
                    </button>
                </form>
                
                <form method="POST" action="{{ url_for('toggle_font_size') }}" style="margin: 0;">
                    <input type="hidden" name="session_id" value="{{ session_id }}">
                    <button type="submit" class="control-btn" title="{{ font_size_tooltip }}" aria-label="Changer la taille de police">
                        {{ font_size_icon }}
                    </button>
                </form>
                
                <form method="POST" action="{{ url_for('toggle_theme') }}" style="margin: 0;">
                    <input type="hidden" name="session_id" value="{{ session_id }}">
                    <button type="submit" class="control-btn" title="Changer le th√®me" aria-label="Changer le th√®me">
                        {{ theme_icon }}
                    </button>
                </form>
            </div>
        </div>
        
        <!-- ===== CHAT MESSAGES AREA ===== -->
        <div class="chat-messages" id="chatMessages">
            {% for message in chat_history %}
                <div class="message {{ message.sender }}">
                    {{ message.text | safe }}
                </div>
            {% endfor %}
        </div>
        
        <!-- ===== QUICK REPLY BUTTONS ===== -->
        {% if not in_conversation %}
        <div class="quick-replies">
            <form method="POST" action="{{ url_for('chat') }}" style="display: inline;">
                <input type="hidden" name="session_id" value="{{ session_id }}">
                <button type="submit" name="question" value="Horaires d'ouverture" class="quick-reply-btn">‚è∞ Horaires</button>
                <button type="submit" name="question" value="Adresse de la mairie" class="quick-reply-btn">üìç Adresse</button>
                <button type="submit" name="question" value="Certificat de r√©sidence" class="quick-reply-btn">üè† Certificat r√©sidence</button>
                <button type="submit" name="question" value="Acte de naissance" class="quick-reply-btn">üìã Acte naissance</button>
                <button type="submit" name="question" value="Carte d'identit√© nationale" class="quick-reply-btn">üÜî CNI</button>
                <button type="submit" name="question" value="Passeport" class="quick-reply-btn">üìò Passeport</button>
            </form>
        </div>
        {% else %}
        <div class="conversation-replies">
            <form method="POST" action="{{ url_for('chat') }}" style="display: inline;">
                <input type="hidden" name="session_id" value="{{ session_id }}">
                {% for button in conversation_buttons %}
                    <button type="submit" name="question" value="{{ button.value }}" class="quick-reply-btn">{{ button.text }}</button>
                {% endfor %}
            </form>
        </div>
        {% endif %}
        
        <!-- ===== CHAT INPUT FORM ===== -->
        <form class="chat-input" method="POST" action="{{ url_for('chat') }}">
            <input type="hidden" name="session_id" value="{{ session_id }}">
            <div class="input-container">
                <input type="text" name="question" id="chatInput" placeholder="ÿßŸÉÿ™ÿ® ÿ≥ÿ§ÿßŸÑŸÉ ŸáŸÜÿß... √âcrivez votre question..." autocomplete="off" required />
                <div class="suggestions-dropup" id="suggestionsDropup">
                    <div class="suggestions-list" id="suggestionsList">
                        <!-- Suggestions will be populated by JavaScript -->
                    </div>
                </div>
            </div>
            <button type="submit" class="send-btn">üì§ ÿ•ÿ±ÿ≥ÿßŸÑ</button>
        </form>
    </div>

    <script>
        // Suggestions data
        const suggestions = [
            { text: "Horaires d'ouverture", icon: "‚è∞", category: "Informations g√©n√©rales" },
            { text: "Adresse de la mairie", icon: "üìç", category: "Informations g√©n√©rales" },
            { text: "Certificat de r√©sidence", icon: "üè†", category: "Documents" },
            { text: "Acte de naissance", icon: "üìã", category: "Documents" },
            { text: "Carte d'identit√© nationale", icon: "üÜî", category: "Documents" },
            { text: "Passeport", icon: "üìò", category: "Documents" },
            { text: "Certificat de mariage", icon: "üíí", category: "Documents" },
            { text: "Taxes municipales", icon: "üí∞", category: "Services" },
            { text: "Prise de rendez-vous", icon: "üìÖ", category: "Services" },
            { text: "Services en ligne", icon: "üíª", category: "Services" },
            { text: "Propret√© (signaler un probl√®me)", icon: "üßπ", category: "Services" },
            { text: "Num√©ro d'urgence", icon: "üö®", category: "Informations g√©n√©rales" },
            { text: "Certificat de d√©c√®s", icon: "‚ö±Ô∏è", category: "Documents" },
            { text: "Permis de conduire", icon: "üöó", category: "Documents" },
            { text: "D√©claration de travaux", icon: "üî®", category: "Services" },
            { text: "Certificat d'urbanisme", icon: "üèóÔ∏è", category: "Services" },
            { text: "Autorisation de stationnement", icon: "üÖøÔ∏è", category: "Services" },
            { text: "Certificat de conformit√©", icon: "‚úÖ", category: "Services" },
            { text: "Attestation de domiciliation", icon: "üè°", category: "Documents" },
            { text: "Copie d'acte", icon: "üìë", category: "Documents" },
            { text: "L√©galisation de signature", icon: "‚úçÔ∏è", category: "Services" },
            { text: "Certificat de nationalit√©", icon: "üá≤üá¶", category: "Documents" },
            { text: "Attestation de r√©sidence", icon: "üè†", category: "Documents" },
            { text: "Certificat de c√©libat", icon: "üë§", category: "Documents" }
        ];

        // Apply theme and font size from server-side preferences
        document.addEventListener('DOMContentLoaded', function() {
            // Apply theme class if needed
            const theme = '{{ theme }}' || 'dark';
            if (theme === 'light') {
                document.body.classList.add('light-theme');
            }
            
            // Apply font size
            const fontSize = '{{ font_size }}' || 'normal';
            if (fontSize !== 'normal') {
                document.body.setAttribute('data-font-size', fontSize);
            }
            
            // Auto-scroll to bottom of chat messages
            const chatMessages = document.getElementById('chatMessages');
            if (chatMessages) {
                setTimeout(() => {
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                }, 100);
            }

            // Initialize suggestions functionality
            initializeSuggestions();
        });

        // Suggestions functionality
        function initializeSuggestions() {
            const chatInput = document.getElementById('chatInput');
            const suggestionsDropup = document.getElementById('suggestionsDropup');
            const suggestionsList = document.getElementById('suggestionsList');
            let selectedIndex = -1;
            let filteredSuggestions = [];

            // Show suggestions when user starts typing
            chatInput.addEventListener('input', function() {
                const query = this.value.toLowerCase().trim();
                
                if (query.length < 2) {
                    hideSuggestions();
                    return;
                }

                // Filter suggestions based on input
                filteredSuggestions = suggestions.filter(suggestion => 
                    suggestion.text.toLowerCase().includes(query) ||
                    suggestion.category.toLowerCase().includes(query)
                );

                if (filteredSuggestions.length > 0) {
                    showSuggestions(filteredSuggestions);
                } else {
                    hideSuggestions();
                }
            });

            // Handle keyboard navigation
            chatInput.addEventListener('keydown', function(e) {
                if (!suggestionsDropup.classList.contains('show')) return;

                switch(e.key) {
                    case 'ArrowUp':
                        e.preventDefault();
                        navigateSuggestions(-1);
                        break;
                    case 'ArrowDown':
                        e.preventDefault();
                        navigateSuggestions(1);
                        break;
                    case 'Enter':
                        if (selectedIndex >= 0 && filteredSuggestions[selectedIndex]) {
                            e.preventDefault();
                            selectSuggestion(filteredSuggestions[selectedIndex]);
                        }
                        break;
                    case 'Escape':
                        hideSuggestions();
                        break;
                }
            });

            // Hide suggestions when clicking outside
            document.addEventListener('click', function(e) {
                if (!chatInput.contains(e.target) && !suggestionsDropup.contains(e.target)) {
                    hideSuggestions();
                }
            });

            function showSuggestions(suggestionsToShow) {
                suggestionsList.innerHTML = '';
                selectedIndex = -1;

                suggestionsToShow.forEach((suggestion, index) => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.innerHTML = `
                        <span class="suggestion-icon">${suggestion.icon}</span>
                        <span class="suggestion-text">${suggestion.text}</span>
                        <span class="suggestion-category">${suggestion.category}</span>
                    `;
                    
                    item.addEventListener('click', () => selectSuggestion(suggestion));
                    item.addEventListener('mouseenter', () => {
                        selectedIndex = index;
                        updateSelection();
                    });
                    
                    suggestionsList.appendChild(item);
                });

                suggestionsDropup.classList.add('show');
            }

            function hideSuggestions() {
                suggestionsDropup.classList.remove('show');
                selectedIndex = -1;
            }

            function navigateSuggestions(direction) {
                if (filteredSuggestions.length === 0) return;

                selectedIndex += direction;
                
                if (selectedIndex >= filteredSuggestions.length) {
                    selectedIndex = 0;
                } else if (selectedIndex < 0) {
                    selectedIndex = filteredSuggestions.length - 1;
                }

                updateSelection();
            }

            function updateSelection() {
                const items = suggestionsList.querySelectorAll('.suggestion-item');
                items.forEach((item, index) => {
                    item.classList.toggle('selected', index === selectedIndex);
                });

                // Scroll to selected item if needed
                if (selectedIndex >= 0) {
                    const selectedItem = items[selectedIndex];
                    if (selectedItem) {
                        selectedItem.scrollIntoView({ block: 'nearest' });
                    }
                }
            }

            function selectSuggestion(suggestion) {
                chatInput.value = suggestion.text;
                hideSuggestions();
                chatInput.focus();
            }
        }
    </script>
</body>
</html> 